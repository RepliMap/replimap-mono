<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Infrastructure Graph - RepliMap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
        }

        #graph-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #graph {
            width: 100%;
            height: 100%;
        }

        /* Container boxes (VPC/Subnet) */
        .container-box {
            rx: 12;
            ry: 12;
        }

        .container-label {
            font-size: 14px;
            font-weight: 600;
            fill: #94a3b8;
            pointer-events: none;
        }

        .container-label.vpc {
            font-size: 16px;
            fill: #f1f5f9;
        }

        /* Nodes */
        .node {
            cursor: pointer;
        }

        .node circle {
            stroke-width: 3px;
            transition: all 0.2s ease;
        }

        .node:hover circle {
            stroke-width: 4px;
            filter: brightness(1.2);
        }

        .node.dimmed circle {
            opacity: 0.2;
        }

        .node.highlighted circle {
            stroke-width: 4px;
            filter: brightness(1.3) drop-shadow(0 0 8px currentColor);
        }

        .node.summary circle {
            stroke-dasharray: 6,3;
        }

        .node.summary:hover circle {
            stroke-dasharray: none;
        }

        .node text {
            font-size: 11px;
            font-weight: 600;
            fill: #f1f5f9;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .node.dimmed text {
            opacity: 0.2;
        }

        /* Environment borders */
        .node[data-env="prod"] circle { stroke: #ef4444 !important; }
        .node[data-env="stage"] circle { stroke: #f59e0b !important; }
        .node[data-env="test"] circle { stroke: #22c55e !important; }
        .node[data-env="dev"] circle { stroke: #3b82f6 !important; }

        /* Links */
        .link {
            stroke: #475569;
            stroke-width: 1.5px;
            stroke-opacity: 0.6;
            fill: none;
        }

        .link.dimmed {
            stroke-opacity: 0.1;
        }

        .link.highlighted {
            stroke: #818cf8;
            stroke-width: 3px;
            stroke-opacity: 1;
        }

        .link.vpc-connection {
            stroke: #6366f1;
            stroke-width: 3px;
            stroke-dasharray: 8,4;
            stroke-opacity: 0.8;
        }

        /* Control Panel */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            padding: 16px;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            z-index: 100;
        }

        .control-panel h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Environment Filter */
        .env-filter {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #334155;
        }

        .env-label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            width: 100%;
            margin-bottom: 4px;
        }

        .env-btn {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid #475569;
            background: #1e293b;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .env-btn:hover { background: #334155; color: #f1f5f9; }
        .env-btn.active { background: #6366f1; border-color: #6366f1; color: white; }

        .env-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .search-box {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #475569;
            background: #1e293b;
            color: #f1f5f9;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .search-box:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .filter-section {
            margin-bottom: 16px;
        }

        .filter-section h3 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #475569;
            background: #1e293b;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #334155;
            color: #f1f5f9;
        }

        .filter-btn.active {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #334155;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #6366f1;
        }

        .stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        /* View Navigation */
        .view-nav {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95);
            border-radius: 8px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #334155;
            z-index: 100;
        }

        .back-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #6366f1;
            background: transparent;
            color: #6366f1;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #6366f1;
            color: white;
        }

        .current-view {
            font-size: 14px;
            font-weight: 600;
            color: #f1f5f9;
        }

        /* Details Panel */
        .details-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            padding: 16px;
            width: 320px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            z-index: 100;
            display: none;
        }

        .details-panel.visible {
            display: block;
        }

        .details-panel h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #f1f5f9;
            word-break: break-word;
        }

        .details-type {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .env-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .env-badge.prod { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .env-badge.stage { background: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.3); }
        .env-badge.test { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
        .env-badge.dev { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3); }
        .env-badge.unknown { background: rgba(107, 114, 128, 0.2); color: #d1d5db; border: 1px solid rgba(107, 114, 128, 0.3); }

        .details-section {
            margin-bottom: 12px;
        }

        .details-section h4 {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 6px;
        }

        .property-list {
            background: #1e293b;
            border-radius: 8px;
            padding: 10px;
        }

        .property-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }

        .property-key {
            color: #94a3b8;
        }

        .property-value {
            color: #f1f5f9;
            font-weight: 500;
            word-break: break-all;
            max-width: 150px;
            text-align: right;
        }

        .connections-list {
            margin-top: 8px;
        }

        .connection-item {
            background: #1e293b;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .connection-item:hover {
            background: #334155;
        }

        .connection-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #334155;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .close-btn:hover {
            background: #475569;
            color: #f1f5f9;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #334155;
            z-index: 100;
        }

        .legend h4 {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Controls */
        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #334155;
            color: #f1f5f9;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 200;
            max-width: 250px;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 2px;
            word-break: break-word;
        }

        .tooltip-type {
            color: #94a3b8;
            font-size: 11px;
        }

        .tooltip-env {
            margin-top: 4px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
        }

        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid #334155;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 14px;
            color: #94a3b8;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="graph-container">
        <!-- Loading overlay -->
        <div class="loading-overlay" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Analyzing infrastructure...</div>
        </div>

        <!-- SVG Graph -->
        <svg id="graph"></svg>

        <!-- View Navigation (shown when drilling down) -->
        <div class="view-nav" id="viewNav" style="display: none;">
            <button class="back-btn" id="backToOverview">
                &#x25C0; Back to Overview
            </button>
            <span class="current-view" id="currentViewLabel"></span>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h2>
                <span style="font-size: 20px;">&#x1F50D;</span>
                AWS Infrastructure
            </h2>

            <!-- Environment Filter -->
            <div class="env-filter">
                <span class="env-label">Environment</span>
                <button class="env-btn active" data-env="all">All</button>
                <button class="env-btn" data-env="prod">
                    <span class="env-dot" style="background: #ef4444"></span>Prod
                </button>
                <button class="env-btn" data-env="stage">
                    <span class="env-dot" style="background: #f59e0b"></span>Stage
                </button>
                <button class="env-btn" data-env="test">
                    <span class="env-dot" style="background: #22c55e"></span>Test
                </button>
                <button class="env-btn" data-env="dev">
                    <span class="env-dot" style="background: #3b82f6"></span>Dev
                </button>
            </div>

            <input type="text" class="search-box" id="search" placeholder="Search resources...">

            <div class="filter-section">
                <h3>Filter by Group</h3>
                <div class="filter-buttons" id="group-filters">
                    <button class="filter-btn active" data-group="all">All</button>
                    {% for group in groups %}
                    <button class="filter-btn" data-group="{{ group }}">{{ group | title }}</button>
                    {% endfor %}
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="resourceCount">{{ node_count }}</div>
                    <div class="stat-label">Resources</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dependencyCount">{{ edge_count }}</div>
                    <div class="stat-label">Dependencies</div>
                </div>
            </div>
        </div>

        <!-- Details Panel -->
        <div class="details-panel" id="details">
            <button class="close-btn" id="close-details">&times;</button>
            <h3 id="detail-name">-</h3>
            <div class="details-type" id="detail-type">-</div>
            <div class="env-badge" id="detail-env" style="display: none;"></div>

            <div class="details-section">
                <h4>Properties</h4>
                <div class="property-list" id="detail-properties">
                    <!-- Properties will be inserted here -->
                </div>
            </div>

            <div class="details-section">
                <h4>Dependencies</h4>
                <div class="connections-list" id="detail-dependencies">
                    <!-- Dependencies will be inserted here -->
                </div>
            </div>

            <div class="details-section">
                <h4>Dependents</h4>
                <div class="connections-list" id="detail-dependents">
                    <!-- Dependents will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <h4>Resource Groups</h4>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #10b981;"></div>
                    <span>Network</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #6366f1;"></div>
                    <span>Compute</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #8b5cf6;"></div>
                    <span>Database</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ec4899;"></div>
                    <span>Storage</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #f59e0b;"></div>
                    <span>Security</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #f472b6;"></div>
                    <span>Messaging</span>
                </div>
            </div>
        </div>

        <!-- Zoom Controls -->
        <div class="controls">
            <button class="control-btn" id="zoom-in" title="Zoom In">+</button>
            <button class="control-btn" id="zoom-out" title="Zoom Out">&#x2212;</button>
            <button class="control-btn" id="zoom-reset" title="Reset View">&#x27F2;</button>
        </div>

        <!-- Tooltip -->
        <div class="tooltip" id="tooltip">
            <div class="tooltip-title"></div>
            <div class="tooltip-type"></div>
            <div class="tooltip-env"></div>
        </div>
    </div>

    <script>
        // Graph data from server
        const graphData = {{ graph_data | safe }};

        // Layout data (hierarchical containers)
        const layoutData = {{ layout_data | safe if layout_data else '{}' }};

        // Configuration
        const config = {
            nodeRadius: 24,
            linkDistance: 120,
            chargeStrength: -400,
            collideRadius: 40,
            useHierarchicalLayout: layoutData.layout_type === 'hierarchical',
        };

        // State
        let selectedNode = null;
        let activeGroup = 'all';
        let activeEnvironment = 'all';
        let searchTerm = '';
        let currentViewMode = 'full';
        let focusVpcId = null;

        // DOM elements
        const svg = d3.select('#graph');
        const container = svg.append('g');
        const tooltip = d3.select('#tooltip');
        const detailsPanel = d3.select('#details');
        const loading = d3.select('#loading');

        // Get dimensions
        const width = window.innerWidth;
        const height = window.innerHeight;

        svg.attr('width', width).attr('height', height);

        // Create zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                container.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Create arrow marker for directed edges
        svg.append('defs').append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '-0 -5 10 10')
            .attr('refX', 28)
            .attr('refY', 0)
            .attr('orient', 'auto')
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .append('path')
            .attr('d', 'M 0,-5 L 10,0 L 0,5')
            .attr('fill', '#475569');

        // Draw container boxes if hierarchical layout
        let containerBoxes = null;
        if (config.useHierarchicalLayout && layoutData.boxes) {
            containerBoxes = container.append('g')
                .attr('class', 'containers')
                .selectAll('g')
                .data(layoutData.boxes)
                .enter()
                .append('g')
                .attr('class', 'container');

            // Draw rectangles
            containerBoxes.append('rect')
                .attr('class', d => `container-box level-${d.level}`)
                .attr('x', d => d.x)
                .attr('y', d => d.y)
                .attr('width', d => d.width)
                .attr('height', d => d.height)
                .attr('fill', d => d.style?.fill || 'rgba(30, 41, 59, 0.3)')
                .attr('stroke', d => d.style?.stroke || '#334155')
                .attr('stroke-width', d => d.style?.strokeWidth || '2')
                .attr('stroke-dasharray', d => d.style?.strokeDasharray || 'none');

            // Draw labels
            containerBoxes.append('text')
                .attr('class', d => `container-label ${d.level === 0 ? 'vpc' : ''}`)
                .attr('x', d => d.x + 16)
                .attr('y', d => d.y + 24)
                .text(d => d.label);
        }

        // Apply positions from layout data if available
        if (config.useHierarchicalLayout && layoutData.nodes) {
            const positionMap = {};
            layoutData.nodes.forEach(n => {
                positionMap[n.id] = { x: n.x, y: n.y, fixed: n.fixed };
            });

            graphData.nodes.forEach(node => {
                const pos = positionMap[node.id];
                if (pos) {
                    node.x = pos.x;
                    node.y = pos.y;
                    node.fx = pos.fixed ? pos.x : null;
                    node.fy = pos.fixed ? pos.y : null;
                }
            });
        }

        // Create force simulation
        const simulation = d3.forceSimulation(graphData.nodes)
            .force('link', d3.forceLink(graphData.links)
                .id(d => d.id)
                .distance(config.linkDistance))
            .force('charge', d3.forceManyBody()
                .strength(config.useHierarchicalLayout ? -100 : config.chargeStrength))
            .force('center', config.useHierarchicalLayout ? null : d3.forceCenter(width / 2, height / 2))
            .force('collide', d3.forceCollide()
                .radius(config.collideRadius));

        // For hierarchical layout, stop simulation immediately
        if (config.useHierarchicalLayout) {
            simulation.stop();
        }

        // Create links
        const link = container.append('g')
            .attr('class', 'links')
            .selectAll('path')
            .data(graphData.links)
            .enter()
            .append('path')
            .attr('class', d => `link ${d.type === 'vpc_connection' ? 'vpc-connection' : ''}`)
            .attr('marker-end', 'url(#arrowhead)');

        // Create nodes
        const node = container.append('g')
            .attr('class', 'nodes')
            .selectAll('g')
            .data(graphData.nodes)
            .enter()
            .append('g')
            .attr('class', d => {
                let classes = 'node';
                if (d.is_summary) classes += ' summary';
                if (d.type === 'vpc_summary') classes += ' vpc-summary';
                if (d.type === 'global_summary') classes += ' global-summary';
                return classes;
            })
            .attr('data-env', d => d.environment || 'unknown')
            .attr('data-node-id', d => d.id)
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded));

        // Set initial positions for hierarchical layout
        if (config.useHierarchicalLayout) {
            node.attr('transform', d => `translate(${d.x || 0},${d.y || 0})`);
        }

        // Add circles to nodes
        node.append('circle')
            .attr('r', d => d.is_summary ? 32 : config.nodeRadius)
            .attr('fill', d => d.color)
            .attr('stroke', d => {
                // Use environment color for border if available
                if (d.env_color) return d.env_color;
                return d3.color(d.color).darker(0.5);
            });

        // Add icon text to nodes
        node.append('text')
            .attr('dy', '0.35em')
            .attr('text-anchor', 'middle')
            .text(d => d.icon);

        // Add name labels below nodes
        node.append('text')
            .attr('class', 'node-label')
            .attr('dy', d => (d.is_summary ? 36 : config.nodeRadius) + 14)
            .attr('text-anchor', 'middle')
            .text(d => truncateText(d.name, 18));

        // Event handlers
        node.on('mouseover', function(event, d) {
            showTooltip(event, d);
        })
        .on('mouseout', hideTooltip)
        .on('click', function(event, d) {
            event.stopPropagation();
            if (d.is_summary && d.expandable) {
                handleSummaryClick(d);
            } else {
                selectNode(d);
            }
        });

        svg.on('click', () => {
            clearSelection();
        });

        // Simulation tick (for force layout)
        simulation.on('tick', () => {
            link.attr('d', d => {
                return `M${d.source.x},${d.source.y} L${d.target.x},${d.target.y}`;
            });

            node.attr('transform', d => `translate(${d.x},${d.y})`);
        });

        // For hierarchical layout, update positions immediately
        if (config.useHierarchicalLayout) {
            link.attr('d', d => {
                const sx = typeof d.source === 'object' ? d.source.x : graphData.nodes.find(n => n.id === d.source)?.x || 0;
                const sy = typeof d.source === 'object' ? d.source.y : graphData.nodes.find(n => n.id === d.source)?.y || 0;
                const tx = typeof d.target === 'object' ? d.target.x : graphData.nodes.find(n => n.id === d.target)?.x || 0;
                const ty = typeof d.target === 'object' ? d.target.y : graphData.nodes.find(n => n.id === d.target)?.y || 0;
                return `M${sx},${sy} L${tx},${ty}`;
            });
        }

        // Hide loading after simulation settles
        simulation.on('end', () => {
            loading.classed('hidden', true);
        });

        // Also hide loading after a timeout
        setTimeout(() => {
            loading.classed('hidden', true);
        }, 2000);

        // Drag functions
        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            if (!config.useHierarchicalLayout) {
                d.fx = null;
                d.fy = null;
            }
        }

        // Tooltip functions
        function showTooltip(event, d) {
            tooltip.select('.tooltip-title').text(d.full_name || d.name);
            tooltip.select('.tooltip-type').text(d.type);

            const envEl = tooltip.select('.tooltip-env');
            if (d.environment && d.environment !== 'unknown') {
                envEl.text(d.environment.toUpperCase())
                    .style('display', 'inline-block')
                    .style('background', d.env_color ? d.env_color + '33' : 'transparent')
                    .style('color', d.env_color || '#94a3b8');
            } else {
                envEl.style('display', 'none');
            }

            tooltip
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px')
                .classed('visible', true);
        }

        function hideTooltip() {
            tooltip.classed('visible', false);
        }

        // Summary node click handler for drill-down
        function handleSummaryClick(d) {
            if (d.type === 'vpc_summary') {
                drillIntoVpc(d.properties.vpc_id);
            }
        }

        // View navigation functions
        function showOverview() {
            currentViewMode = 'overview';
            focusVpcId = null;

            document.getElementById('viewNav').style.display = 'none';

            node.style('display', d => d.is_summary ? null : 'none');
            link.style('display', l => {
                const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                const sourceNode = graphData.nodes.find(n => n.id === sourceId);
                const targetNode = graphData.nodes.find(n => n.id === targetId);
                return (sourceNode?.is_summary && targetNode?.is_summary) ? null : 'none';
            });

            if (containerBoxes) {
                containerBoxes.style('display', 'none');
            }

            zoomToFit();
        }

        function drillIntoVpc(vpcId) {
            currentViewMode = 'vpc_detail';
            focusVpcId = vpcId;

            document.getElementById('viewNav').style.display = 'flex';

            const vpcNode = graphData.nodes.find(n =>
                n.id === vpcId || n.properties?.vpc_id === vpcId
            );
            const vpcName = vpcNode?.name || vpcId;
            document.getElementById('currentViewLabel').textContent = vpcName;

            node.style('display', d => {
                if (d.id === vpcId) return null;
                if (d.properties?.vpc_id === vpcId) return null;
                if (d.is_summary) return 'none';
                return 'none';
            });

            link.style('display', l => {
                const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                const sourceNode = graphData.nodes.find(n => n.id === sourceId);
                const targetNode = graphData.nodes.find(n => n.id === targetId);
                const sourceVpc = sourceNode?.properties?.vpc_id;
                const targetVpc = targetNode?.properties?.vpc_id;
                return (sourceVpc === vpcId || targetVpc === vpcId) ? null : 'none';
            });

            if (containerBoxes) {
                containerBoxes.style('display', d => {
                    return (d.id === vpcId || d.parent_id === vpcId) ? null : 'none';
                });
            }

            zoomToFit();
        }

        function zoomToFit() {
            const visibleNodes = graphData.nodes.filter(d => {
                const nodeEl = document.querySelector(`[data-node-id="${CSS.escape(d.id)}"]`);
                return nodeEl && getComputedStyle(nodeEl).display !== 'none';
            });

            if (visibleNodes.length === 0) return;

            const xs = visibleNodes.map(d => d.x || 0);
            const ys = visibleNodes.map(d => d.y || 0);
            const padding = 100;

            const minX = Math.min(...xs) - padding;
            const maxX = Math.max(...xs) + padding;
            const minY = Math.min(...ys) - padding;
            const maxY = Math.max(...ys) + padding;

            const w = maxX - minX;
            const h = maxY - minY;
            const scale = Math.min(width / w, height / h, 2) * 0.9;
            const tx = (width - w * scale) / 2 - minX * scale;
            const ty = (height - h * scale) / 2 - minY * scale;

            svg.transition()
                .duration(500)
                .call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
        }

        // Node selection
        function selectNode(d) {
            selectedNode = d;

            const connectedNodeIds = new Set();
            connectedNodeIds.add(d.id);

            graphData.links.forEach(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                if (sourceId === d.id) connectedNodeIds.add(targetId);
                if (targetId === d.id) connectedNodeIds.add(sourceId);
            });

            node.classed('dimmed', n => !connectedNodeIds.has(n.id));
            node.classed('highlighted', n => n.id === d.id);

            link.classed('dimmed', l => {
                const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                return sourceId !== d.id && targetId !== d.id;
            });
            link.classed('highlighted', l => {
                const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                return sourceId === d.id || targetId === d.id;
            });

            showDetails(d);
        }

        function clearSelection() {
            selectedNode = null;
            node.classed('dimmed', false).classed('highlighted', false);
            link.classed('dimmed', false).classed('highlighted', false);
            detailsPanel.classed('visible', false);
        }

        function showDetails(d) {
            document.getElementById('detail-name').textContent = d.full_name || d.name;
            document.getElementById('detail-type').textContent = d.type;

            // Environment badge
            const envBadge = document.getElementById('detail-env');
            if (d.environment && d.environment !== 'unknown') {
                envBadge.textContent = d.environment;
                envBadge.className = `env-badge ${d.environment}`;
                envBadge.style.display = 'inline-flex';
            } else {
                envBadge.style.display = 'none';
            }

            // Properties
            const propsContainer = document.getElementById('detail-properties');
            propsContainer.innerHTML = '';

            const props = d.properties || {};
            const displayProps = Object.entries(props).filter(([key, value]) =>
                !['is_group', 'ids', 'member_ids', 'unique_tags'].includes(key) &&
                value !== null && value !== undefined
            );

            if (displayProps.length > 0) {
                displayProps.forEach(([key, value]) => {
                    const item = document.createElement('div');
                    item.className = 'property-item';
                    let displayValue = value;
                    if (typeof value === 'object') {
                        displayValue = JSON.stringify(value);
                    }
                    item.innerHTML = `
                        <span class="property-key">${key}</span>
                        <span class="property-value">${truncateText(String(displayValue), 25)}</span>
                    `;
                    propsContainer.appendChild(item);
                });
            } else {
                propsContainer.innerHTML = '<div class="property-item"><span class="property-key">No properties</span></div>';
            }

            // Dependencies
            const depsContainer = document.getElementById('detail-dependencies');
            depsContainer.innerHTML = '';

            const dependencies = graphData.links
                .filter(l => {
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    return sourceId === d.id;
                })
                .map(l => {
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return graphData.nodes.find(n => n.id === targetId);
                })
                .filter(Boolean);

            if (dependencies.length > 0) {
                dependencies.slice(0, 10).forEach(dep => {
                    const item = document.createElement('div');
                    item.className = 'connection-item';
                    item.innerHTML = `
                        <div class="connection-icon" style="background: ${dep.color}">${dep.icon}</div>
                        <span>${truncateText(dep.name, 25)}</span>
                    `;
                    item.onclick = () => selectNode(dep);
                    depsContainer.appendChild(item);
                });
                if (dependencies.length > 10) {
                    const more = document.createElement('div');
                    more.style.cssText = 'font-size: 12px; color: #64748b; padding: 8px;';
                    more.textContent = `... and ${dependencies.length - 10} more`;
                    depsContainer.appendChild(more);
                }
            } else {
                depsContainer.innerHTML = '<div style="font-size: 12px; color: #64748b; padding: 8px;">No dependencies</div>';
            }

            // Dependents
            const dependentsContainer = document.getElementById('detail-dependents');
            dependentsContainer.innerHTML = '';

            const dependents = graphData.links
                .filter(l => {
                    const targetId = typeof l.target === 'object' ? l.target.id : l.target;
                    return targetId === d.id;
                })
                .map(l => {
                    const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
                    return graphData.nodes.find(n => n.id === sourceId);
                })
                .filter(Boolean);

            if (dependents.length > 0) {
                dependents.slice(0, 10).forEach(dep => {
                    const item = document.createElement('div');
                    item.className = 'connection-item';
                    item.innerHTML = `
                        <div class="connection-icon" style="background: ${dep.color}">${dep.icon}</div>
                        <span>${truncateText(dep.name, 25)}</span>
                    `;
                    item.onclick = () => selectNode(dep);
                    dependentsContainer.appendChild(item);
                });
                if (dependents.length > 10) {
                    const more = document.createElement('div');
                    more.style.cssText = 'font-size: 12px; color: #64748b; padding: 8px;';
                    more.textContent = `... and ${dependents.length - 10} more`;
                    dependentsContainer.appendChild(more);
                }
            } else {
                dependentsContainer.innerHTML = '<div style="font-size: 12px; color: #64748b; padding: 8px;">No dependents</div>';
            }

            detailsPanel.classed('visible', true);
        }

        // Search functionality
        document.getElementById('search').addEventListener('input', function(e) {
            searchTerm = e.target.value.toLowerCase();
            filterNodes();
        });

        // Environment filter
        document.querySelectorAll('.env-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.env-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeEnvironment = this.dataset.env;
                filterNodes();
            });
        });

        // Group filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeGroup = this.dataset.group;
                filterNodes();
            });
        });

        function filterNodes() {
            node.style('display', d => {
                // In overview mode, only show summaries
                if (currentViewMode === 'overview' && !d.is_summary) return 'none';
                // In VPC detail mode, only show resources in that VPC
                if (currentViewMode === 'vpc_detail') {
                    if (d.is_summary) return 'none';
                    if (d.id !== focusVpcId && d.properties?.vpc_id !== focusVpcId) return 'none';
                }

                const matchesSearch = d.name.toLowerCase().includes(searchTerm) ||
                                     d.id.toLowerCase().includes(searchTerm) ||
                                     d.type.toLowerCase().includes(searchTerm);
                const matchesGroup = activeGroup === 'all' || d.group === activeGroup;
                const matchesEnv = activeEnvironment === 'all' || d.environment === activeEnvironment;

                return matchesSearch && matchesGroup && matchesEnv ? null : 'none';
            });

            link.style('display', l => {
                const sourceVisible = isNodeVisible(typeof l.source === 'object' ? l.source : graphData.nodes.find(n => n.id === l.source));
                const targetVisible = isNodeVisible(typeof l.target === 'object' ? l.target : graphData.nodes.find(n => n.id === l.target));
                return sourceVisible && targetVisible ? null : 'none';
            });
        }

        function isNodeVisible(d) {
            if (!d) return false;
            if (currentViewMode === 'overview' && !d.is_summary) return false;
            if (currentViewMode === 'vpc_detail') {
                if (d.is_summary) return false;
                if (d.id !== focusVpcId && d.properties?.vpc_id !== focusVpcId) return false;
            }
            const matchesSearch = d.name.toLowerCase().includes(searchTerm) ||
                                 d.id.toLowerCase().includes(searchTerm) ||
                                 d.type.toLowerCase().includes(searchTerm);
            const matchesGroup = activeGroup === 'all' || d.group === activeGroup;
            const matchesEnv = activeEnvironment === 'all' || d.environment === activeEnvironment;
            return matchesSearch && matchesGroup && matchesEnv;
        }

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => {
            svg.transition().call(zoom.scaleBy, 1.3);
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            svg.transition().call(zoom.scaleBy, 0.7);
        });

        document.getElementById('zoom-reset').addEventListener('click', () => {
            zoomToFit();
        });

        // Close details panel
        document.getElementById('close-details').addEventListener('click', () => {
            clearSelection();
        });

        // Back to overview
        document.getElementById('backToOverview').addEventListener('click', () => {
            const hasSummaryNodes = graphData.nodes.some(n => n.is_summary);
            if (hasSummaryNodes) {
                showOverview();
            } else {
                // No overview mode available, just show all
                currentViewMode = 'full';
                document.getElementById('viewNav').style.display = 'none';
                node.style('display', null);
                link.style('display', null);
                if (containerBoxes) containerBoxes.style('display', null);
                zoomToFit();
            }
        });

        // Utility functions
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength - 1) + '\u2026' : text;
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            svg.attr('width', newWidth).attr('height', newHeight);
            if (!config.useHierarchicalLayout) {
                simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
                simulation.alpha(0.3).restart();
            }
        });

        // Initialize view
        function initializeView() {
            const hasSummaryNodes = graphData.nodes.some(n => n.is_summary);
            if (hasSummaryNodes) {
                showOverview();
            } else {
                currentViewMode = 'full';
                zoomToFit();
            }
        }

        // Start initialization after a brief delay
        setTimeout(initializeView, 100);
    </script>
</body>
</html>
