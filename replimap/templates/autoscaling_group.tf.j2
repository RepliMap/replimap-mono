# Auto Scaling Group: {{ resource.original_name }}
resource "aws_autoscaling_group" "{{ resource.terraform_name }}" {
  name = "{{ resource.config.name }}"

  min_size         = {{ resource.config.min_size }}
  max_size         = {{ resource.config.max_size }}
  desired_capacity = {{ resource.config.desired_capacity }}

{% if resource.config.launch_template.id %}
  launch_template {
{% if resource.config.launch_template.id is tf_ref %}
    id      = {{ resource.config.launch_template.id }}
{% else %}
{% set lt_resource = graph.get_resource(resource.config.launch_template.id) %}
{% if lt_resource and lt_resource.terraform_name %}
    id      = aws_launch_template.{{ lt_resource.terraform_name }}.id
{% else %}
    id      = "{{ resource.config.launch_template.id }}"
{% endif %}
{% endif %}
    version = "$Latest"
  }
{% endif %}

{% if resource.config.subnet_ids %}
  vpc_zone_identifier = [
{% for subnet_id in resource.config.subnet_ids %}
{% if subnet_id %}
{% if subnet_id is tf_ref %}
    {{ subnet_id }},
{% else %}
{% set subnet_resource = graph.get_resource(subnet_id) %}
{% if subnet_resource and subnet_resource.terraform_name %}
    aws_subnet.{{ subnet_resource.terraform_name }}.id,
{% else %}
    "{{ subnet_id }}",
{% endif %}
{% endif %}
{% endif %}
{% endfor %}
  ]
{% endif %}

{% if resource.config.target_group_arns %}
  target_group_arns = [
{% for tg_arn in resource.config.target_group_arns %}
{% if tg_arn is tf_ref %}
    {{ tg_arn }},
{% else %}
{% set tg_resource = graph.get_resource(tg_arn) %}
{% if tg_resource and tg_resource.terraform_name %}
    aws_lb_target_group.{{ tg_resource.terraform_name }}.arn,
{% else %}
    "{{ tg_arn }}",
{% endif %}
{% endif %}
{% endfor %}
  ]
{% endif %}

  health_check_type         = "{{ resource.config.health_check_type }}"
  health_check_grace_period = {{ resource.config.health_check_grace_period }}
  default_cooldown          = {{ resource.config.default_cooldown }}

  tag {
    key                 = "Name"
    value               = "{{ resource.original_name }}"
    propagate_at_launch = true
  }

  tag {
    key                 = "Environment"
    value               = var.environment
    propagate_at_launch = true
  }

  tag {
    key                 = "ManagedBy"
    value               = "replimap"
    propagate_at_launch = true
  }

  tag {
    key                 = "SourceId"
    value               = "{{ resource.id }}"
    propagate_at_launch = true
  }
{% for key, value in resource.tags.items() if key != 'Name' %}

  tag {
    key                 = {{ key | quote_key }}
    value               = {{ value | quote }}
    propagate_at_launch = true
  }
{% endfor %}
}
