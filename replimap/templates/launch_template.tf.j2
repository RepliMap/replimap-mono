# Launch Template: {{ resource.original_name }}
resource "aws_launch_template" "{{ resource.terraform_name }}" {
  name = "{{ resource.config.name }}"

{% if resource.config.instance_type %}
  instance_type = "{{ resource.config.instance_type }}"
{% endif %}
{% if resource.config.image_id %}
  image_id = "{{ resource.config.image_id }}"
{% endif %}
{% if resource.config.key_name %}
  key_name = "{{ resource.config.key_name }}"
{% endif %}

{% if resource.config.security_group_ids %}
  vpc_security_group_ids = [
{% for sg_id in resource.config.security_group_ids %}
{% if sg_id is tf_ref %}
    {{ sg_id }},
{% else %}
{% set sg_resource = graph.get_resource(sg_id) %}
{% if sg_resource and sg_resource.terraform_name %}
    aws_security_group.{{ sg_resource.terraform_name }}.id,
{% else %}
    "{{ sg_id }}",
{% endif %}
{% endif %}
{% endfor %}
  ]
{% endif %}

{% if resource.config.iam_instance_profile.arn or resource.config.iam_instance_profile.name %}
  iam_instance_profile {
{% if resource.config.iam_instance_profile.name %}
    name = "{{ resource.config.iam_instance_profile.name }}"
{% endif %}
  }
{% endif %}

  monitoring {
    enabled = {{ resource.config.monitoring.get('Enabled', false) | lower }}
  }

  tag_specifications {
    resource_type = "instance"
    tags = {
      Name        = "{{ resource.original_name }}"
      Environment = var.environment
      ManagedBy   = "replimap"
    }
  }

  tags = {
    Name        = "{{ resource.original_name }}"
    Environment = var.environment
    ManagedBy   = "replimap"
    SourceId    = "{{ resource.id }}"
{% for key, value in resource.tags.items() if key != 'Name' %}
    {{ key | quote_key }} = {{ value | quote }}
{% endfor %}
  }
}
